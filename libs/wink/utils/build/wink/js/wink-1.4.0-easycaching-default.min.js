if(typeof wink=="undefined")wink={};
wink.cache=function(){var p=true,B="wink",m="resources",C=5242880,D=1814400,u=null,q,o,k,l,r,s,v,w,x={};x.load=function(b,a,c){E();c=c||{};if(c.dbName)B=c.dbName;if(c.dbTable)m=c.dbTable;if(c.dbSize)C=c.dbSize;if(c.expires)D=c.expires;if(c.useLocalDatabase===false)p=false;var d=K(b),e=function(){if(k.length>0){l=l.concat(k);p=false;k=[];y(d,0,e)}else a&&a({errors:l,loadErrors:r,resourcesCleaned:s,resourcesOldVersion:v,useOfLocalDatabase:p,loadTime:(new Date).getTime()-o})};y(d,0,e)};x.resetDatabase=
function(b){E();var a=function(){if(b){if(k.length>0)l=l.concat(k);b({errors:l})}},c=function(){L(a)};try{F(c)}catch(d){l.push("[cache.resetDatabase] Error : "+d.toString());a()}};var E=function(){o=(new Date).getTime();q=document.getElementsByTagName("head")[0];k=[];l=[];r=[];s=[];v=[];w=false},y=function(b,a,c){for(var d=b.length;!b[a]&&a<d;)a++;a>=d||k.length>0?c():M(b[a],function(){y(b,++a,c)})},K=function(b){var a=[],c,d=b.length;for(c=0;c<d;c++){var e=b[c],f=e.group;f||(f=0);(a[f]?a[f]:a[f]=
[]).push(e)}return a},M=function(b,a){if((window.openDatabase&&window.XMLHttpRequest?true:false)&&p){var c=function(){if(k.length>0)a();else{var e=function(){G(b,a,true)};if(w)e();else{w=true;N(e)}}};try{F(c)}catch(d){H("Connect error: "+d.toString());a()}}else G(b,a,false)},G=function(b,a,c){var d=b.length;z.load(d,a);for(a=0;a<d;a++){var e=b[a],f=e.type,g=e.url;if(c){var h=e.expires?e.expires:D;e=e.version?e.version:1;g=I(g);O(g.protocol+"//"+g.host+(g.port!=0?":"+g.port:"")+g.path+g.query+g.hash,
f,e,h)}else t(g,null,f)}},z=function(){var b=null,a=null,c=null;return{load:function(d,e){c=e;b=d;a=0},markAsLoaded:function(){a++;a==b&&c()}}}(),t=function(b,a,c){var d=function(){z.markAsLoaded()};if(c=="js")P(b,a,d);else c=="css"&&Q(b,a,d)},P=function(b,a,c){var d=document.createElement("script");d.type="text/javascript";if(b!=null){d.onload=function(){d.onload=d.onerror=null;c()};d.onerror=function(){d.onload=d.onerror=null;r.push(b);c()};d.src=b;q.appendChild(d)}else{d.textContent=a;q.appendChild(d);
c()}},Q=function(b,a,c){var d;if(b!=null){d=document.createElement("link");d.rel="stylesheet";d.type="text/css";d.href=b}else{d=document.createElement("style");d.setAttribute("type","text/css");b=document.createTextNode(a);d.appendChild(b)}q.appendChild(d);c()},F=function(b){if(u==null){u=window.openDatabase(B,"1.0","Local cache",C);n("CREATE TABLE IF NOT EXISTS "+m+"(id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, url TEXT NOT NULL UNIQUE, data TEXT NOT NULL, type TEXT NOT NULL, version REAL NOT NULL, expires REAL NOT NULL);",
[],b)}else b()},L=function(b){n("DROP TABLE "+m,[],b,function(a,c){A(a,c);b()})},J=function(b,a){n("DELETE FROM "+m+" WHERE url=?;",[b],a)},O=function(b,a,c,d){var e=function(){var f=new XMLHttpRequest,g;f.open("GET",b,false);f.send(null);if(f.readyState==4&&(f.status>=200&&f.status<400||f.status==0)){g=f.responseText;if(a=="css"){f=I(b);if(f.file!="")f.path=f.path.replace(f.file,"");g=R(g,f)}n("INSERT INTO "+m+" (url, type, version, expires, data) VALUES (?,?,?,?,?);",[b,a,c,o+d*1E3,g],function(){t(null,
g,a)},function(h,i){A(h,i);t(null,"",a)})}else{r.push(b);z.markAsLoaded()}};n("SELECT version, expires, data FROM "+m+" WHERE url=?;",[b],function(f,g){var h,i=true;if(g&&g.rows){var j=g.rows.length;if(j==0)i=false;else if(j==1)if(j=g.rows.item(0))if(j.version!=c)v.push(b);else if(d==-1)s.push(b);else if(j.expires>o)h=j.data}if(h)t(null,h,a);else i?J(b,e):e()})},N=function(b){n("SELECT url FROM "+m+" WHERE expires<?;",[o],function(a,c){if(c&&c.rows){var d=-1,e=c.rows,f=e.length,g=function(){d++;if(d>=
f)b();else{var h=e.item(d);if(h&&h.url){s.push(h.url);J(h.url,g)}}};g()}})},n=function(b,a,c,d){var e=c?c:S,f=d?d:A;u.transaction(function(g){g.executeSql(b,a,e,f)})},H=function(b){k.push("Cache System Error: "+b)},A=function(b,a){H("[SqlError] code: "+a.code+", Message: "+a.message);return true},S=function(){return true},I=function(b){var a=document.createElement("a");a.href=b;return{source:b,protocol:a.protocol,host:a.hostname,port:a.port,query:a.search,file:(a.pathname.match(/\/([^\/?#]+)$/i)||
[,""])[1],hash:a.hash,path:a.pathname.replace(/^([^\/])/,"/$1")}},R=function(b,a){var c=null;c=/(url)( *)(\()( *)('|")?(.*)('|")?( *)(\))/i;var d=a.protocol+"//"+a.host+a.path,e=-1,f=-1,g=-1;f=-1;var h=null;var i=g=null,j=[];i=0;for(e=b.indexOf("url");e!=-1;){f=b.indexOf(")",e+3);h=b.substring(e,f+1);f=e+3;g=h.indexOf("../");if(g!=-1){g=h.replace(c,"$1$3"+d+"$6$9");i=b.substring(i,e);i+=g;j.push(i);i=e+h.length}e=b.indexOf("url",f)}j.push(b.substring(i));return c=j.join("")};return x}();
wink.load=wink.cache.load;
